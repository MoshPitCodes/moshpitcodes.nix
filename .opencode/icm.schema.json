{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "icm.schema.json",
  "title": "ICM Plugin Configuration",
  "description": "Configuration schema for the Intelligent Context Manager plugin for OpenCode",
  "type": "object",
  "additionalProperties": false,
  "properties": {
    "$schema": {
      "type": "string",
      "description": "JSON Schema reference for IDE autocomplete"
    },
    "enabled": {
      "type": "boolean",
      "default": true,
      "description": "Enable or disable the ICM plugin"
    },
    "debug": {
      "type": "boolean",
      "default": false,
      "description": "Enable debug logging to .opencode/logs/icm_debug.jsonl"
    },
    "pruneNotification": {
      "type": "string",
      "enum": ["off", "minimal", "detailed"],
      "default": "detailed",
      "description": "Level of notification shown when pruning occurs"
    },
    "pruneNotificationType": {
      "type": "string",
      "enum": ["chat", "toast"],
      "default": "chat",
      "description": "Where to display prune notifications"
    },
    "commands": {
      "type": "object",
      "description": "Configuration for /icm slash commands",
      "additionalProperties": false,
      "properties": {
        "enabled": {
          "type": "boolean",
          "default": true,
          "description": "Enable /icm slash commands"
        },
        "protectedTools": {
          "type": "array",
          "items": { "type": "string" },
          "default": [],
          "description": "Additional tool names to protect from pruning via commands"
        }
      }
    },
    "manualMode": {
      "type": "object",
      "description": "Manual mode disables autonomous context management",
      "additionalProperties": false,
      "properties": {
        "enabled": {
          "type": "boolean",
          "default": false,
          "description": "Start sessions with manual mode enabled"
        },
        "automaticStrategies": {
          "type": "boolean",
          "default": true,
          "description": "Keep automatic strategies running even in manual mode"
        }
      }
    },
    "turnProtection": {
      "type": "object",
      "description": "Protect recent tool outputs from pruning",
      "additionalProperties": false,
      "properties": {
        "enabled": {
          "type": "boolean",
          "default": false,
          "description": "Enable turn-based protection"
        },
        "turns": {
          "type": "number",
          "default": 4,
          "minimum": 1,
          "description": "Number of recent turns to protect"
        }
      }
    },
    "protectedFilePatterns": {
      "type": "array",
      "items": { "type": "string" },
      "default": [],
      "description": "Glob patterns for files protected from pruning (e.g., '**/*.config.ts')"
    },
    "tools": {
      "type": "object",
      "description": "LLM-driven pruning tool configuration",
      "additionalProperties": false,
      "properties": {
        "settings": {
          "type": "object",
          "description": "Shared settings for all pruning tools",
          "additionalProperties": false,
          "properties": {
            "nudgeEnabled": {
              "type": "boolean",
              "default": true,
              "description": "Periodically nudge the LLM to use pruning tools"
            },
            "nudgeFrequency": {
              "type": "number",
              "default": 10,
              "minimum": 1,
              "description": "Number of tool results between nudges"
            },
            "contextLimit": {
              "description": "Token threshold triggering compress nudge. Number or \"X%\" of model context window.",
              "default": 100000,
              "oneOf": [
                { "type": "number", "minimum": 1000 },
                { "type": "string", "pattern": "^\\d+(?:\\.\\d+)?%$" }
              ]
            },
            "modelLimits": {
              "type": "object",
              "description": "Per-model context limit overrides by provider/model key",
              "additionalProperties": {
                "oneOf": [
                  { "type": "number" },
                  { "type": "string", "pattern": "^\\d+(?:\\.\\d+)?%$" }
                ]
              }
            },
            "protectedTools": {
              "type": "array",
              "items": { "type": "string" },
              "default": [],
              "description": "Additional tools to protect from pruning"
            }
          }
        },
        "distill": {
          "type": "object",
          "description": "Distill tool: extracts key findings before removing raw content",
          "additionalProperties": false,
          "properties": {
            "permission": {
              "type": "string",
              "enum": ["ask", "allow", "deny"],
              "default": "allow",
              "description": "Permission mode (deny disables the tool)"
            },
            "showDistillation": {
              "type": "boolean",
              "default": false,
              "description": "Show distillation output in the UI"
            }
          }
        },
        "compress": {
          "type": "object",
          "description": "Compress tool: collapses conversation ranges into summaries",
          "additionalProperties": false,
          "properties": {
            "permission": {
              "type": "string",
              "enum": ["ask", "allow", "deny"],
              "default": "deny",
              "description": "Permission mode (deny disables the tool)"
            },
            "showCompression": {
              "type": "boolean",
              "default": false,
              "description": "Show compression output in the UI"
            }
          }
        },
        "prune": {
          "type": "object",
          "description": "Prune tool: removes completed or noisy tool content",
          "additionalProperties": false,
          "properties": {
            "permission": {
              "type": "string",
              "enum": ["ask", "allow", "deny"],
              "default": "allow",
              "description": "Permission mode (deny disables the tool)"
            }
          }
        }
      }
    },
    "strategies": {
      "type": "object",
      "description": "Automatic pruning strategies (zero LLM cost)",
      "additionalProperties": false,
      "properties": {
        "deduplication": {
          "type": "object",
          "description": "Remove duplicate and near-duplicate tool calls",
          "additionalProperties": false,
          "properties": {
            "enabled": {
              "type": "boolean",
              "default": true,
              "description": "Enable deduplication"
            },
            "fuzzyThreshold": {
              "type": "number",
              "default": 0.92,
              "minimum": 0,
              "maximum": 1,
              "description": "Similarity threshold for fuzzy matching (0-1). Set to 1.0 to disable fuzzy matching."
            },
            "protectedTools": {
              "type": "array",
              "items": { "type": "string" },
              "default": [],
              "description": "Tools excluded from deduplication"
            }
          }
        },
        "supersedeWrites": {
          "type": "object",
          "description": "Remove write outputs when the file is subsequently re-read",
          "additionalProperties": false,
          "properties": {
            "enabled": {
              "type": "boolean",
              "default": true,
              "description": "Enable supersede writes strategy"
            }
          }
        },
        "purgeErrors": {
          "type": "object",
          "description": "Remove tool inputs for errored tools after N turns",
          "additionalProperties": false,
          "properties": {
            "enabled": {
              "type": "boolean",
              "default": true,
              "description": "Enable error purging"
            },
            "turns": {
              "type": "number",
              "default": 4,
              "minimum": 1,
              "description": "Turns before error inputs are purged"
            },
            "protectedTools": {
              "type": "array",
              "items": { "type": "string" },
              "default": [],
              "description": "Tools excluded from error purging"
            }
          }
        },
        "smartCompression": {
          "type": "object",
          "description": "Replace large tool outputs with structural summaries (preserves key metadata)",
          "additionalProperties": false,
          "properties": {
            "enabled": {
              "type": "boolean",
              "default": true,
              "description": "Enable smart compression"
            },
            "minLength": {
              "type": "number",
              "default": 2000,
              "minimum": 500,
              "description": "Minimum output length (chars) before compression is considered"
            },
            "preserveStructure": {
              "type": "boolean",
              "default": true,
              "description": "Extract and preserve code structure (imports, exports, functions)"
            }
          }
        }
      }
    },
    "semantic": {
      "type": "object",
      "description": "Semantic analysis for intelligent pruning decisions",
      "additionalProperties": false,
      "properties": {
        "enabled": {
          "type": "boolean",
          "default": true,
          "description": "Enable semantic content scoring"
        },
        "trackDependencies": {
          "type": "boolean",
          "default": true,
          "description": "Track content dependencies (file read/write chains)"
        },
        "decayRate": {
          "type": "number",
          "default": 0.05,
          "minimum": 0,
          "maximum": 1,
          "description": "How quickly importance score decays per turn (0-1)"
        },
        "minImportanceToKeep": {
          "type": "number",
          "default": 20,
          "minimum": 0,
          "maximum": 100,
          "description": "Minimum importance score to keep content (0-100)"
        }
      }
    },
    "memory": {
      "type": "object",
      "description": "Session memory for cross-session learning",
      "additionalProperties": false,
      "properties": {
        "enabled": {
          "type": "boolean",
          "default": true,
          "description": "Enable session memory persistence"
        },
        "persistPath": {
          "type": "string",
          "default": ".opencode/data/icm",
          "description": "Directory for memory persistence (relative to project root)"
        },
        "learnPrunePatterns": {
          "type": "boolean",
          "default": true,
          "description": "Learn which tools are frequently pruned across sessions"
        }
      }
    },
    "cacheAwareness": {
      "type": "object",
      "description": "Cache-aware pruning to minimize prompt cache invalidation",
      "additionalProperties": false,
      "properties": {
        "enabled": {
          "type": "boolean",
          "default": true,
          "description": "Enable cache-aware pruning"
        },
        "provider": {
          "type": "string",
          "enum": ["auto", "anthropic", "openai", "none"],
          "default": "auto",
          "description": "Provider for cache strategy (auto-detect from model)"
        },
        "minNetSavings": {
          "type": "number",
          "default": 500,
          "minimum": 0,
          "description": "Minimum net token savings to justify a prune (accounts for cache miss cost)"
        }
      }
    }
  }
}
