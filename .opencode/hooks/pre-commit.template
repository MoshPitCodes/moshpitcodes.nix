#!/bin/bash
#
# TD Task-Driven Development Pre-Commit Hook
#
# This hook ensures all modified files are linked to a TD task before commit.
#
# Installation:
#   cp .opencode/hooks/pre-commit.template .git/hooks/pre-commit
#   chmod +x .git/hooks/pre-commit
#
# Bypass (when absolutely necessary):
#   git commit --no-verify
#

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check if TD is installed
if ! command -v td &> /dev/null; then
    echo -e "${YELLOW}⚠️  TD CLI not found. Skipping TD validation.${NC}"
    echo -e "${YELLOW}   Install: https://github.com/marcus/td${NC}"
    exit 0
fi

# Check if TD is initialized
if [ ! -f ".todos/issues.db" ]; then
    echo -e "${YELLOW}⚠️  TD not initialized in this project. Skipping validation.${NC}"
    echo -e "${YELLOW}   Run: td init${NC}"
    exit 0
fi

# Get list of files being committed
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR)

if [ -z "$STAGED_FILES" ]; then
    echo -e "${GREEN}✅ No files staged for commit${NC}"
    exit 0
fi

# Filter for trackable files (code files, not logs/data/build artifacts)
TRACKABLE_EXTENSIONS="\.(ts|tsx|js|jsx|go|py|java|kt|rs|c|cpp|h|hpp|rb|php|swift|vue|svelte|sql|graphql|proto|css|scss|html|yaml|yml|toml|json|sh|md)$"
EXCLUDED_PATTERNS="node_modules/|dist/|build/|\.git/|target/|vendor/|\.next/|\.nuxt/|\.svelte-kit/|out/|coverage/|__pycache__/|\.opencode/logs/|\.opencode/data/"

TRACKED_FILES=""
for file in $STAGED_FILES; do
    # Check if file matches trackable extensions
    if echo "$file" | grep -qE "$TRACKABLE_EXTENSIONS"; then
        # Check if file is not in excluded directories
        if ! echo "$file" | grep -qE "$EXCLUDED_PATTERNS"; then
            TRACKED_FILES="$TRACKED_FILES $file"
        fi
    fi
done

if [ -z "$TRACKED_FILES" ]; then
    echo -e "${GREEN}✅ No trackable files in this commit${NC}"
    exit 0
fi

# Get current TD status
TD_STATUS=$(td status --json 2>/dev/null || echo "{}")
FOCUS_TASK=$(echo "$TD_STATUS" | grep -o '"focus":{[^}]*"key":"[^"]*"' | grep -o '"key":"[^"]*"' | cut -d'"' -f4)
IN_PROGRESS_COUNT=$(echo "$TD_STATUS" | grep -o '"in_progress":\[[^\]]*\]' | grep -o '"key":"[^"]*"' | wc -l)

# Check if any task is active
if [ -z "$FOCUS_TASK" ] && [ "$IN_PROGRESS_COUNT" -eq 0 ]; then
    echo -e "${RED}❌ Error: No TD task active${NC}"
    echo -e "${RED}   You are committing code changes without an active task.${NC}"
    echo ""
    echo -e "${YELLOW}Files being committed:${NC}"
    for file in $TRACKED_FILES; do
        echo -e "  - $file"
    done
    echo ""
    echo -e "${YELLOW}To fix this, start a task before committing:${NC}"
    echo -e "  td start <task-id>"
    echo -e "  td create \"<task-description>\" --start"
    echo ""
    echo -e "${YELLOW}Or link these files to an existing task:${NC}"
    echo -e "  td link <task-key> $TRACKED_FILES"
    echo ""
    echo -e "${YELLOW}To bypass this check (NOT recommended):${NC}"
    echo -e "  git commit --no-verify"
    echo ""
    exit 1
fi

# Get task key (from focus or first in_progress)
TASK_KEY="$FOCUS_TASK"
if [ -z "$TASK_KEY" ]; then
    TASK_KEY=$(echo "$TD_STATUS" | grep -o '"in_progress":\[[^\]]*"key":"[^"]*"' | head -1 | grep -o '"key":"[^"]*"' | cut -d'"' -f4)
fi

# Check which files are linked to current task
UNLINKED_FILES=""
for file in $TRACKED_FILES; do
    # Query TD to see if file is linked to the current task
    # Note: This is a simplified check - adjust based on your TD version
    if ! td status --file "$file" 2>/dev/null | grep -q "$TASK_KEY"; then
        UNLINKED_FILES="$UNLINKED_FILES $file"
    fi
done

if [ -n "$UNLINKED_FILES" ]; then
    echo -e "${YELLOW}⚠️  Warning: Some files are not linked to task $TASK_KEY${NC}"
    echo ""
    echo -e "${YELLOW}Unlinked files:${NC}"
    for file in $UNLINKED_FILES; do
        echo -e "  - $file"
    done
    echo ""
    echo -e "${YELLOW}Auto-linking files to task $TASK_KEY...${NC}"
    
    # Auto-link files to current task
    for file in $UNLINKED_FILES; do
        td link "$TASK_KEY" "$file" 2>/dev/null || true
    done
    
    echo -e "${GREEN}✅ Files linked to task $TASK_KEY${NC}"
fi

echo -e "${GREEN}✅ All tracked files are linked to task $TASK_KEY${NC}"
echo -e "${GREEN}   Files in commit: $(echo $TRACKED_FILES | wc -w)${NC}"
exit 0
