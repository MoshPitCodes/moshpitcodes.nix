name: Test configurations

on:
  workflow_dispatch:
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  test-configurations:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        host: [desktop, laptop, vmware-guest]
      fail-fast: false

    steps:
    - name: Checkout repository
      uses: actions/checkout@v6

    - name: Install Nix
      uses: cachix/install-nix-action@v31
      with:
        nix_path: nixpkgs=channel:nixos-unstable
        extra_nix_config: |
          experimental-features = nix-command flakes
          access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}

    - name: Free up disk space
      run: |
        echo "üßπ Freeing up disk space..."
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /usr/local/lib/android
        sudo rm -rf /opt/ghc
        sudo rm -rf /opt/hostedtoolcache/CodeQL
        sudo docker image prune --all --force
        df -h
        echo "‚úÖ Disk space freed"

    - name: Setup Cachix
      env:
        CACHIX_AUTH_TOKEN: ${{ secrets.CACHIX_AUTH_TOKEN }}
      if: env.CACHIX_AUTH_TOKEN != ''
      uses: cachix/cachix-action@v16
      with:
        name: nix-community
        authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
        skipPush: true

    - name: Create secrets.nix for CI
      run: |
        echo "üìù Creating secrets.nix for CI environment..."
        cp secrets.nix.example secrets.nix
        echo "‚úÖ Secrets file created"

    - name: Resolve ${{ matrix.host }} primary user
      run: |
        echo "üîé Resolving primary user for ${{ matrix.host }}..."
        USERNAME=$(nix eval --raw .#nixosConfigurations.${{ matrix.host }}.config.users.users --apply 'users: builtins.head (builtins.filter (name: ((builtins.getAttr name users).isNormalUser or false)) (builtins.attrNames users))')
        echo "CI_NIX_USER=$USERNAME" >> "$GITHUB_ENV"
        echo "‚úÖ Using user: $USERNAME"

    - name: Test ${{ matrix.host }} system configuration validity
      run: |
        echo "üîç Testing ${{ matrix.host }} system configuration validity..."
        nix eval --show-trace .#nixosConfigurations.${{ matrix.host }}.config.system.build.toplevel.drvPath
        echo "‚úÖ ${{ matrix.host }} system configuration is valid"

    - name: Test ${{ matrix.host }} system modules load
      run: |
        echo "üß© Testing ${{ matrix.host }} system modules load..."
        nix eval --show-trace .#nixosConfigurations.${{ matrix.host }}.config.system.nixos.version
        echo "‚úÖ ${{ matrix.host }} system modules load successfully"

    - name: Test ${{ matrix.host }} user configuration
      run: |
        echo "üë§ Testing ${{ matrix.host }} user configuration..."
        nix eval --show-trace .#nixosConfigurations.${{ matrix.host }}.config.users.users.${{ env.CI_NIX_USER }}.isNormalUser
        echo "‚úÖ ${{ matrix.host }} user configuration is valid"

    - name: Test ${{ matrix.host }} home-manager user packages
      run: |
        echo "üì¶ Testing ${{ matrix.host }} home-manager user packages..."
        nix eval --show-trace .#nixosConfigurations.${{ matrix.host }}.config.home-manager.users.${{ env.CI_NIX_USER }}.home.packages --apply "builtins.length"
        echo "‚úÖ ${{ matrix.host }} home-manager user packages are accessible"

    - name: Test ${{ matrix.host }} home-manager modules
      run: |
        echo "üè† Testing ${{ matrix.host }} home-manager modules..."
        nix eval --show-trace .#nixosConfigurations.${{ matrix.host }}.config.home-manager.users.${{ env.CI_NIX_USER }}.programs.git.enable
        echo "‚úÖ ${{ matrix.host }} home-manager modules are accessible"
